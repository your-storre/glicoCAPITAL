<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | GlicoCapital</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (keep all previous CSS styles exactly as they were) ... */
        
        /* Success Message Sticky - FIXED VERSION */
        .sticky-success {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 12px 25px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            animation: slideDown 0.5s ease;
            opacity: 0;
            visibility: hidden;
        }
        
        .sticky-success.show {
            opacity: 1;
            visibility: visible;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-30px);
                visibility: hidden;
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
                visibility: visible;
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
                visibility: visible;
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-30px);
                visibility: hidden;
            }
        }
        
        /* ... (rest of the CSS remains the same) ... */
    </style>
</head>
<body>
    <!-- Premium Header -->
    <header>
        <div class="logo">
            <img src="https://glicogroup.net/storage/glico-capital-logo.png" alt="GlicoCapital Logo">
            <h1>GlicoCapital</h1>
        </div>
        <div class="user-menu">
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
            <div class="user-avatar" id="userAvatar">
                <span id="avatarInitial">F</span>
            </div>
        </div>
    </header>

    <!-- Success Message (Initially hidden) -->
    <div class="sticky-success" id="successMessage">
        <i class="fas fa-check-circle"></i>
        <span id="successText">Operation successful!</span>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Welcome Section -->
        <div class="welcome-section animate-in" style="text-align: center; margin-bottom: 20px;">
            <h2 style="font-size: 1.8rem; margin-bottom: 8px;">Account Settings</h2>
            <p style="font-size: 1rem; opacity: 0.9;">Manage your account security and information</p>
        </div>

        <!-- Profile Information -->
        <div class="profile-info animate-in">
            <div class="profile-item">
                <div class="profile-label">Full Name</div>
                <div class="profile-value" id="profileName">Loading...</div>
            </div>
            <div class="profile-item">
                <div class="profile-label">Email</div>
                <div class="profile-value" id="profileEmail">Loading...</div>
            </div>
            <div class="profile-item">
                <div class="profile-label">Account Created</div>
                <div class="profile-value" id="profileCreated">Loading...</div>
            </div>
            <div class="profile-item">
                <div class="profile-label">Account Status</div>
                <div class="profile-value" style="color: var(--success);" id="profileStatus">Loading...</div>
            </div>
            <!-- Current Secret Key Display -->
            <div class="profile-item">
                <div class="profile-label">Current Security Key</div>
                <div class="profile-value">
                    <span id="currentKeyDisplay">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Settings Grid -->
        <div class="settings-grid">
            <div class="setting-item animate-in" onclick="changePassword()">
                <div class="setting-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="setting-content">
                    <h4>Change Password</h4>
                    <p>Update your account password</p>
                </div>
            </div>

            <div class="setting-item animate-in" onclick="manageSecretKey()">
                <div class="setting-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="setting-content">
                    <h4>Security Key</h4>
                    <p>Set or update your secret key</p>
                </div>
            </div>

            <div class="setting-item animate-in" onclick="updateBankInfo()">
                <div class="setting-icon">
                    <i class="fas fa-university"></i>
                </div>
                <div class="setting-content">
                    <h4>Update Bank Info</h4>
                    <p>Change your bank details for payouts</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button class="close-modal" onclick="closeModal()">×</button>
            </div>
            
            <!-- Password Requirements -->
            <div class="password-requirements">
                <div class="requirement-item" id="reqLength">
                    <i class="fas fa-circle requirement-not-met"></i>
                    <span>At least 8 characters</span>
                </div>
                <div class="requirement-item" id="reqUppercase">
                    <i class="fas fa-circle requirement-not-met"></i>
                    <span>At least one uppercase letter</span>
                </div>
                <div class="requirement-item" id="reqLowercase">
                    <i class="fas fa-circle requirement-not-met"></i>
                    <span>At least one lowercase letter</span>
                </div>
                <div class="requirement-item" id="reqNumber">
                    <i class="fas fa-circle requirement-not-met"></i>
                    <span>At least one number</span>
                </div>
                <div class="requirement-item" id="reqSpecial">
                    <i class="fas fa-circle requirement-not-met"></i>
                    <span>At least one special character</span>
                </div>
            </div>
            
            <div class="form-group">
                <label>Current Password</label>
                <div class="password-input-container">
                    <input type="password" id="currentPassword" placeholder="Enter current password">
                    <button type="button" class="password-toggle" onclick="togglePassword('currentPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label>New Password</label>
                <div class="password-input-container">
                    <input type="password" id="newPassword" placeholder="Enter new password (min 8 chars)">
                    <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="password-strength">
                    <div class="password-strength-bar" id="passwordStrengthBar"></div>
                </div>
                <div class="strength-text" id="strengthText">Password strength</div>
            </div>
            
            <div class="form-group">
                <label>Confirm New Password</label>
                <div class="password-input-container">
                    <input type="password" id="confirmPassword" placeholder="Confirm new password">
                    <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div id="passwordMatch" style="font-size: 0.85rem; margin-top: 5px;"></div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-secondary" onclick="updatePassword()" id="updatePasswordBtn">
                    Update Password
                </button>
            </div>
        </div>
    </div>

    <!-- Secret Key Modal -->
    <div class="modal" id="secretKeyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Security Key</h3>
                <button class="close-modal" onclick="closeModal()">×</button>
            </div>
            
            <div class="current-key-display">
                <div class="key-info">
                    <div class="key-label">Current Key</div>
                    <div class="key-value" id="displayCurrentKey">••••••</div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Current Password</label>
                <div class="password-input-container">
                    <input type="password" id="currentPasswordForKey" placeholder="Enter current password">
                    <button type="button" class="password-toggle" onclick="togglePassword('currentPasswordForKey')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label>New Security Key</label>
                <div class="password-input-container">
                    <input type="password" id="newSecretKey" placeholder="Enter new key (6-12 chars)">
                    <button type="button" class="password-toggle" onclick="togglePassword('newSecretKey')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <small style="opacity: 0.7; display: block; margin-top: 5px;">
                    Must be 6-12 characters. This key will be used for login verification.
                </small>
            </div>
            
            <div class="form-group">
                <label>Confirm Security Key</label>
                <div class="password-input-container">
                    <input type="password" id="confirmSecretKey" placeholder="Confirm new key">
                    <button type="button" class="password-toggle" onclick="togglePassword('confirmSecretKey')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div id="secretKeyMatch" style="font-size: 0.85rem; margin-top: 5px;"></div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-secondary" onclick="updateSecretKey()" id="updateSecretKeyBtn">
                    Save Security Key
                </button>
            </div>
        </div>
    </div>

    <!-- Premium Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <span class="nav-icon"><i class="fas fa-home"></i></span>
            <span>Home</span>
        </a>
        <a href="payouts.html" class="nav-item">
            <span class="nav-icon"><i class="fas fa-wallet"></i></span>
            <span>Payouts</span>
        </a>
        <a href="partners.html" class="nav-item">
            <span class="nav-icon"><i class="fas fa-handshake"></i></span>
            <span>Partners</span>
        </a>
        <a href="settings.html" class="nav-item active">
            <span class="nav-icon"><i class="fas fa-cog"></i></span>
            <span>Settings</span>
        </a>
        <a href="support.html" class="nav-item">
            <span class="nav-icon"><i class="fas fa-headset"></i></span>
            <span>Support</span>
        </a>
    </nav>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQDX4eyp7fbmHqbyjytWZEv-jK7XxynqA",
            authDomain: "ggic-investment.firebaseapp.com",
            databaseURL: "https://ggic-investment-default-rtdb.firebaseio.com",
            projectId: "ggic-investment",
            storageBucket: "ggic-investment.firebasestorage.app",
            messagingSenderId: "805530882494",
            appId: "1:805530882494:web:574b965b3ed0402b0f69ef",
            measurementId: "G-NR5R3EJM93"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        console.log("Firebase initialized");

        // DOM Elements
        const userAvatar = document.getElementById('userAvatar');
        const avatarInitial = document.getElementById('avatarInitial');
        const currentKeyDisplay = document.getElementById('currentKeyDisplay');
        const displayCurrentKey = document.getElementById('displayCurrentKey');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profileCreated = document.getElementById('profileCreated');
        const profileStatus = document.getElementById('profileStatus');
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');

        // Current user and secret key
        let currentUser = null;
        let userSecretKey = null;
        let passwordRequirementsMet = false;
        let successTimeout = null;

        // Initialize page
        function initPage() {
            checkAuth();
            setupPasswordValidation();
            setupSecretKeyValidation();
        }

        // Check authentication
        function checkAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'login.html';
                } else {
                    currentUser = user;
                    loadUserProfile(user);
                    loadUserAvatar(user);
                    await loadUserSecretKey(user.uid);
                    console.log("User logged in:", user.email);
                }
            });
        }

        // Show sticky success message - SIMPLE AND WORKING VERSION
        function showStickySuccess(message) {
            console.log("Showing success message:", message);
            
            // Clear any existing timeout
            if (successTimeout) {
                clearTimeout(successTimeout);
            }
            
            // Hide first to reset animation
            successMessage.classList.remove('show');
            
            // Update text
            successText.textContent = message;
            
            // Force reflow to restart animation
            void successMessage.offsetWidth;
            
            // Show with animation
            setTimeout(() => {
                successMessage.classList.add('show');
            }, 10);
            
            // Auto-hide after 5 seconds
            successTimeout = setTimeout(() => {
                hideStickySuccess();
            }, 5000);
        }

        // Hide success message
        function hideStickySuccess() {
            successMessage.classList.remove('show');
        }

        // Load user profile information
        async function loadUserProfile(user) {
            try {
                // Default Felicity user details
                const felicityEmail = "iamgenefelicity@gmail.com";
                
                // Set profile information
                if (user.email === felicityEmail) {
                    // For Felicity user
                    profileName.textContent = "Acheampong Felicity";
                    profileEmail.textContent = felicityEmail;
                    profileStatus.textContent = "✓ Verified";
                    profileStatus.style.color = "var(--success)";
                    
                    // Set account creation date to April 2025
                    profileCreated.textContent = "April 15, 2025";
                } else {
                    // For other users
                    profileName.textContent = user.displayName || "User";
                    profileEmail.textContent = user.email || "No email";
                    
                    // Check email verification status
                    if (user.emailVerified) {
                        profileStatus.textContent = "✓ Verified";
                        profileStatus.style.color = "var(--success)";
                    } else {
                        profileStatus.textContent = "⚠ Not Verified";
                        profileStatus.style.color = "var(--warning)";
                    }
                    
                    // Format account creation date from Firebase
                    if (user.metadata && user.metadata.creationTime) {
                        const createdDate = new Date(user.metadata.creationTime);
                        profileCreated.textContent = createdDate.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } else {
                        profileCreated.textContent = "N/A";
                    }
                }
                
                // Try to get user data from Firestore
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.fullName) {
                            profileName.textContent = userData.fullName;
                        }
                        if (userData.accountCreated) {
                            profileCreated.textContent = new Date(userData.accountCreated).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                        }
                    }
                } catch (dbError) {
                    console.log("No Firestore user data found, using default");
                }
                
            } catch (error) {
                console.error("Error loading user profile:", error);
                // Set default Felicity values
                profileName.textContent = "Acheampong Felicity";
                profileEmail.textContent = "iamgenefelicity@gmail.com";
                profileStatus.textContent = "✓ Verified";
                profileStatus.style.color = "var(--success)";
                profileCreated.textContent = "April 15, 2025";
            }
        }

        // Load user avatar
        function loadUserAvatar(user) {
            if (user.photoURL) {
                avatarInitial.style.display = 'none';
                userAvatar.innerHTML = `<img src="${user.photoURL}" alt="Profile">`;
            } else {
                // For Felicity user, use 'F'
                if (user.email === "iamgenefelicity@gmail.com") {
                    avatarInitial.textContent = 'F';
                } else if (user.displayName) {
                    const initials = user.displayName.split(' ').map(n => n[0]).join('').toUpperCase();
                    avatarInitial.textContent = initials || 'U';
                } else if (user.email) {
                    avatarInitial.textContent = user.email[0].toUpperCase();
                }
            }
        }

        // Load user's secret key from Firebase
        async function loadUserSecretKey(userId) {
            try {
                console.log("Loading secret key for user:", userId);
                
                // Try Realtime Database first
                const secretKeyRef = rtdb.ref(`secretKeys/${userId}`);
                const snapshot = await secretKeyRef.get();
                
                if (snapshot.exists()) {
                    userSecretKey = snapshot.val().key;
                    console.log("Secret key found in RTDB:", userSecretKey);
                } else {
                    // Try Firestore as backup
                    const userDoc = await db.collection('users').doc(userId).get();
                    if (userDoc.exists() && userDoc.data().secretKey) {
                        userSecretKey = userDoc.data().secretKey;
                        console.log("Secret key found in Firestore:", userSecretKey);
                    } else {
                        // If no key exists yet, set default
                        userSecretKey = "123456"; // Default key
                        console.log("No secret key found, using default");
                    }
                }
                
                // Update UI display
                updateKeyDisplay();
                
            } catch (error) {
                console.error("Error loading secret key:", error);
                userSecretKey = "123456"; // Default on error
                updateKeyDisplay();
            }
        }

        // Update key display in UI
        function updateKeyDisplay() {
            if (userSecretKey) {
                // Show first 2 and last 2 characters, hide the rest
                const keyLength = userSecretKey.length;
                const maskedKey = userSecretKey.substring(0, 2) + 
                                '•'.repeat(Math.max(0, keyLength - 4)) + 
                                userSecretKey.substring(keyLength - 2);
                currentKeyDisplay.textContent = maskedKey;
                displayCurrentKey.textContent = maskedKey;
            } else {
                currentKeyDisplay.textContent = "123456";
                displayCurrentKey.textContent = "••••••";
            }
        }

        // Setup password validation
        function setupPasswordValidation() {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', validatePassword);
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', checkPasswordMatch);
            }
        }

        // Setup secret key validation
        function setupSecretKeyValidation() {
            const newSecretKeyInput = document.getElementById('newSecretKey');
            const confirmSecretKeyInput = document.getElementById('confirmSecretKey');
            
            if (newSecretKeyInput && confirmSecretKeyInput) {
                newSecretKeyInput.addEventListener('input', checkSecretKeyMatch);
                confirmSecretKeyInput.addEventListener('input', checkSecretKeyMatch);
            }
        }

        // Validate password strength and requirements
        function validatePassword() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('passwordStrengthBar');
            const strengthText = document.getElementById('strengthText');
            
            // Reset requirements
            let requirements = {
                length: false,
                uppercase: false,
                lowercase: false,
                number: false,
                special: false
            };
            
            let strength = 0;
            
            // Check requirements
            if (password.length >= 8) {
                requirements.length = true;
                strength++;
            }
            
            if (/[A-Z]/.test(password)) {
                requirements.uppercase = true;
                strength++;
            }
            
            if (/[a-z]/.test(password)) {
                requirements.lowercase = true;
                strength++;
            }
            
            if (/[0-9]/.test(password)) {
                requirements.number = true;
                strength++;
            }
            
            if (/[^A-Za-z0-9]/.test(password)) {
                requirements.special = true;
                strength++;
            }
            
            // Update requirement indicators
            updateRequirement('reqLength', requirements.length);
            updateRequirement('reqUppercase', requirements.uppercase);
            updateRequirement('reqLowercase', requirements.lowercase);
            updateRequirement('reqNumber', requirements.number);
            updateRequirement('reqSpecial', requirements.special);
            
            // Update strength bar
            let strengthClass = '';
            let strengthMessage = '';
            
            if (strength <= 1) {
                strengthClass = 'strength-weak';
                strengthMessage = 'Weak password';
            } else if (strength <= 3) {
                strengthClass = 'strength-medium';
                strengthMessage = 'Medium strength';
            } else {
                strengthClass = 'strength-strong';
                strengthMessage = 'Strong password';
            }
            
            strengthBar.className = 'password-strength-bar ' + strengthClass;
            strengthText.textContent = strengthMessage;
            
            // Check if all requirements are met
            passwordRequirementsMet = Object.values(requirements).every(req => req === true);
            
            // Check password match
            checkPasswordMatch();
        }

        // Update requirement indicator
        function updateRequirement(elementId, met) {
            const element = document.getElementById(elementId);
            if (element) {
                const icon = element.querySelector('i');
                const text = element.querySelector('span');
                
                if (met) {
                    icon.className = 'fas fa-check-circle requirement-met';
                    text.style.opacity = '1';
                } else {
                    icon.className = 'fas fa-circle requirement-not-met';
                    text.style.opacity = '0.6';
                }
            }
        }

        // Check if passwords match
        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchElement = document.getElementById('passwordMatch');
            
            if (!newPassword || !confirmPassword) {
                matchElement.textContent = '';
                return;
            }
            
            if (newPassword === confirmPassword) {
                matchElement.textContent = '✓ Passwords match';
                matchElement.style.color = 'var(--success)';
            } else {
                matchElement.textContent = '✗ Passwords do not match';
                matchElement.style.color = 'var(--danger)';
            }
        }

        // Check if secret keys match
        function checkSecretKeyMatch() {
            const newSecretKey = document.getElementById('newSecretKey')?.value || '';
            const confirmSecretKey = document.getElementById('confirmSecretKey')?.value || '';
            const matchElement = document.getElementById('secretKeyMatch');
            
            if (!newSecretKey || !confirmSecretKey) {
                matchElement.textContent = '';
                return;
            }
            
            if (newSecretKey === confirmSecretKey) {
                matchElement.textContent = '✓ Keys match';
                matchElement.style.color = 'var(--success)';
            } else {
                matchElement.textContent = '✗ Keys do not match';
                matchElement.style.color = 'var(--danger)';
            }
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = document.querySelector(`#${inputId} + .password-toggle i`);
            
            if (input.type === 'password') {
                input.type = 'text';
                button.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                button.className = 'fas fa-eye';
            }
        }

        // Modal functions
        function changePassword() {
            document.getElementById('passwordModal').classList.add('active');
            // Trigger initial validation
            validatePassword();
        }

        function manageSecretKey() {
            document.getElementById('secretKeyModal').classList.add('active');
            updateKeyDisplay();
        }

        function updateBankInfo() {
            window.location.href = 'bank-update.html';
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            clearForms();
            resetButtons();
            resetValidation();
        }

        // Clear form inputs
        function clearForms() {
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('currentPasswordForKey').value = '';
            document.getElementById('newSecretKey').value = '';
            document.getElementById('confirmSecretKey').value = '';
        }

        // Reset validation states
        function resetValidation() {
            const strengthBar = document.getElementById('passwordStrengthBar');
            const strengthText = document.getElementById('strengthText');
            const matchElement = document.getElementById('passwordMatch');
            const secretKeyMatchElement = document.getElementById('secretKeyMatch');
            
            if (strengthBar) strengthBar.className = 'password-strength-bar';
            if (strengthText) strengthText.textContent = 'Password strength';
            if (matchElement) matchElement.textContent = '';
            if (secretKeyMatchElement) secretKeyMatchElement.textContent = '';
            
            // Reset requirement indicators
            ['reqLength', 'reqUppercase', 'reqLowercase', 'reqNumber', 'reqSpecial'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const icon = element.querySelector('i');
                    const text = element.querySelector('span');
                    icon.className = 'fas fa-circle requirement-not-met';
                    text.style.opacity = '0.6';
                }
            });
        }

        // Reset buttons to original state
        function resetButtons() {
            const updatePasswordBtn = document.getElementById('updatePasswordBtn');
            const updateSecretKeyBtn = document.getElementById('updateSecretKeyBtn');
            
            if (updatePasswordBtn) {
                updatePasswordBtn.innerHTML = 'Update Password';
                updatePasswordBtn.disabled = false;
            }
            
            if (updateSecretKeyBtn) {
                updateSecretKeyBtn.innerHTML = 'Save Security Key';
                updateSecretKeyBtn.disabled = false;
            }
        }

        // Update password function - SIMPLIFIED AND WORKING
        async function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const updatePasswordBtn = document.getElementById('updatePasswordBtn');
            
            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                showStickySuccess('Please fill in all fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showStickySuccess('New passwords do not match');
                return;
            }
            
            if (!passwordRequirementsMet) {
                showStickySuccess('Password does not meet all requirements');
                return;
            }
            
            if (newPassword.length < 8) {
                showStickySuccess('Password must be at least 8 characters');
                return;
            }
            
            // Check if new password is same as current
            if (newPassword === currentPassword) {
                showStickySuccess('New password cannot be the same as current password');
                return;
            }
            
            try {
                // Show loading state
                updatePasswordBtn.innerHTML = '<div class="loader"></div> Updating...';
                updatePasswordBtn.disabled = true;
                
                console.log("Starting password update...");
                
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                
                // Update password in Firebase Authentication
                await currentUser.updatePassword(newPassword);
                
                // Save to Firestore for audit trail
                await db.collection('users').doc(currentUser.uid).set({
                    passwordUpdated: new Date().toISOString(),
                    email: currentUser.email,
                    lastPasswordChange: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Show success message
                showStickySuccess('Password changed successfully!');
                
                // Clear form and close modal
                clearForms();
                resetValidation();
                closeModal();
                
                // Reset button
                updatePasswordBtn.innerHTML = 'Update Password';
                updatePasswordBtn.disabled = false;
                
            } catch (error) {
                console.error("Password update error:", error);
                
                // Firebase specific error handling
                let errorMessage = 'Error updating password';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Current password is incorrect';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Try a stronger password.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Session expired. Please login again and try.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many attempts. Please try again later.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your connection.';
                } else {
                    errorMessage = 'Error: ' + error.message;
                }
                
                showStickySuccess(errorMessage);
                
                // Reset button
                updatePasswordBtn.innerHTML = 'Update Password';
                updatePasswordBtn.disabled = false;
            }
        }

        // Update secret key function - SIMPLIFIED AND WORKING
        async function updateSecretKey() {
            const currentPassword = document.getElementById('currentPasswordForKey').value;
            const newSecretKey = document.getElementById('newSecretKey').value;
            const confirmSecretKey = document.getElementById('confirmSecretKey').value;
            const updateSecretKeyBtn = document.getElementById('updateSecretKeyBtn');
            
            // Validation
            if (!currentPassword || !newSecretKey || !confirmSecretKey) {
                showStickySuccess('Please fill in all fields');
                return;
            }
            
            if (newSecretKey !== confirmSecretKey) {
                showStickySuccess('Security keys do not match');
                return;
            }
            
            if (newSecretKey.length < 6 || newSecretKey.length > 12) {
                showStickySuccess('Security key must be 6-12 characters');
                return;
            }
            
            try {
                // Show loading state
                updateSecretKeyBtn.innerHTML = '<div class="loader"></div> Saving...';
                updateSecretKeyBtn.disabled = true;
                
                console.log("Starting secret key update...");
                
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                
                // Create data object
                const secretKeyData = {
                    key: newSecretKey,
                    updatedAt: new Date().toISOString(),
                    userId: currentUser.uid,
                    email: currentUser.email
                };
                
                // Save to Realtime Database
                await rtdb.ref(`secretKeys/${currentUser.uid}`).set(secretKeyData);
                
                // Also save to Firestore
                await db.collection('users').doc(currentUser.uid).set({
                    secretKey: newSecretKey,
                    secretKeyUpdated: new Date().toISOString(),
                    email: currentUser.email,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Update local state
                userSecretKey = newSecretKey;
                
                // Update UI immediately
                updateKeyDisplay();
                
                // Show success message
                showStickySuccess('Security key updated successfully!');
                
                console.log("Secret key updated successfully!");
                
                // Clear and close modal
                clearForms();
                resetValidation();
                closeModal();
                
                // Reset button
                updateSecretKeyBtn.innerHTML = 'Save Security Key';
                updateSecretKeyBtn.disabled = false;
                
            } catch (error) {
                console.error("Secret key update error:", error);
                
                let errorMessage = 'Error updating security key';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Current password is incorrect';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many attempts. Please try again later.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Session expired. Please login again and try.';
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Please check Firebase rules.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your connection.';
                } else {
                    errorMessage = 'Error: ' + error.message;
                }
                
                showStickySuccess(errorMessage);
                
                // Reset button
                updateSecretKeyBtn.innerHTML = 'Save Security Key';
                updateSecretKeyBtn.disabled = false;
            }
        }

        // Logout function
        async function logout() {
            try {
                await auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Logout error:", error);
                window.location.href = 'login.html';
            }
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });

        // Prevent form submission on enter
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' && !e.target.type.includes('button')) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
