<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | GlicoCapital</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Premium Color Scheme - Matching Dashboard */
        :root {
            --primary: #1a365d;
            --primary-dark: #0f2040;
            --primary-light: #2d4a80;
            --secondary: #d4af37;
            --secondary-dark: #b8941f;
            --accent: #00b4d8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --card-bg: rgba(255, 255, 255, 0.95);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a365d 0%, #0f2040 50%, #2d4a80 100%);
            color: var(--light);
            min-height: 100vh;
            padding-bottom: 90px;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000" opacity="0.03"><polygon fill="white" points="0,1000 1000,0 1000,1000"/></svg>');
            background-size: cover;
            z-index: -1;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Premium Header - Matching Dashboard */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            background: rgba(26, 54, 93, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo img {
            height: 38px;
            filter: brightness(0) invert(1);
        }
        
        .logo h1 {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(90deg, white, var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            font-size: 0.9rem;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Logout Button */
        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 10px;
            padding: 8px 15px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
        }
        
        /* Welcome Section */
        .welcome-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .welcome-section h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .welcome-section p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        /* Settings Grid */
        .settings-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .setting-item {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .setting-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        
        .setting-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
        }
        
        .setting-content {
            flex: 1;
        }
        
        .setting-content h4 {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .setting-content p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Current Key Display */
        .current-key-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--glass-border);
        }
        
        .key-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .key-label {
            font-weight: 600;
            color: var(--secondary);
            font-size: 0.9rem;
        }
        
        .key-value {
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            letter-spacing: 1px;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border: 1px solid var(--glass-border);
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: white;
        }
        
        input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }
        
        /* Password Strength Indicator */
        .password-strength {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .password-strength-bar {
            height: 100%;
            width: 0%;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .strength-weak {
            background: var(--danger);
            width: 33%;
        }
        
        .strength-medium {
            background: var(--warning);
            width: 66%;
        }
        
        .strength-strong {
            background: var(--success);
            width: 100%;
        }
        
        .strength-text {
            font-size: 0.8rem;
            margin-top: 5px;
            opacity: 0.7;
        }
        
        /* Password Requirements */
        .password-requirements {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid var(--glass-border);
        }
        
        .requirement-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .requirement-item:last-child {
            margin-bottom: 0;
        }
        
        .requirement-item i {
            font-size: 0.8rem;
        }
        
        .requirement-met {
            color: var(--success);
        }
        
        .requirement-not-met {
            color: var(--danger);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a365d 0%, #0f2040 50%, #2d4a80 100%);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--glass-border);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-dark));
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--secondary);
            color: var(--secondary);
        }
        
        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Profile Info */
        .profile-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--glass-border);
        }
        
        .profile-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .profile-item:last-child {
            border-bottom: none;
        }
        
        .profile-label {
            font-weight: 600;
            color: var(--secondary);
            font-size: 0.9rem;
        }
        
        .profile-value {
            font-size: 1rem;
        }
        
        /* Premium Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 54, 93, 0.95);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 14px 0;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-top: 1px solid var(--glass-border);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray-light);
            font-size: 0.7rem;
            transition: all 0.3s ease;
            position: relative;
            padding: 6px 10px;
            border-radius: 10px;
            min-width: 50px;
        }
        
        .nav-item.active, .nav-item:hover {
            color: var(--secondary);
            background: rgba(212, 175, 55, 0.1);
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            top: -12px;
            width: 24px;
            height: 2px;
            background: var(--secondary);
            border-radius: 2px;
        }
        
        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-in {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        /* Loader */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Show/Hide Password Toggle */
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
        }
        
        .password-toggle:hover {
            color: var(--secondary);
        }
        
        .password-input-container {
            position: relative;
        }
        
        /* Success Message Sticky */
        .sticky-success {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 12px 25px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            header {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .logout-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .sticky-success {
                top: 70px;
                width: 90%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Premium Header -->
    <header>
        <div class="logo">
            <img src="https://glicogroup.net/storage/glico-capital-logo.png" alt="GlicoCapital Logo">
            <h1>GlicoCapital</h1>
        </div>
        <div class="user-menu">
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
            <div class="user-avatar" id="userAvatar">
                <span id="avatarInitial">F</span>
            </div>
        </div>
    </header>

    <!-- Success Message (Initially hidden) -->
    <div class="sticky-success" id="successMessage" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span id="successText">Operation successful!</span>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Welcome Section -->
        <div class="welcome-section animate-in" style="text-align: center; margin-bottom: 20px;">
            <h2 style="font-size: 1.8rem; margin-bottom: 8px;">Account Settings</h2>
            <p style="font-size: 1rem; opacity: 0.9;">Manage your account security and information</p>
        </div>

        <!-- Profile Information -->
        <div class="profile-info animate-in">
            <div class="profile-item">
                <div class="profile-label">Full Name</div>
                <div class="profile-value" id="profileName">Loading...</div>
            </div>
            <div class="profile-item">
                <div class="profile-label">Email</div>
                <div class="profile-value" id="profileEmail">Loading...</div>
            </div>
            <div class="profile-item">
                <div class="profile-label">Account Created</div>
                <div class="profile-value" id="profileCreated">Loading...</div>
            </div>
            <div class="profile-item">
                <div class="profile-label">Account Status</div>
                <div class="profile-value" style="color: var(--success);" id="profileStatus">Loading...</div>
            </div>
            <!-- Current Secret Key Display -->
            <div class="profile-item">
                <div class="profile-label">Current Security Key</div>
                <div class="profile-value">
                    <span id="currentKeyDisplay">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Settings Grid -->
        <div class="settings-grid">
            <div class="setting-item animate-in" onclick="changePassword()">
                <div class="setting-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="setting-content">
                    <h4>Change Password</h4>
                    <p>Update your account password</p>
                </div>
            </div>

            <div class="setting-item animate-in" onclick="manageSecretKey()">
                <div class="setting-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="setting-content">
                    <h4>Security Key</h4>
                    <p>Set or update your secret key</p>
                </div>
            </div>

            <div class="setting-item animate-in" onclick="updateBankInfo()">
                <div class="setting-icon">
                    <i class="fas fa-university"></i>
                </div>
                <div class="setting-content">
                    <h4>Update Bank Info</h4>
                    <p>Change your bank details for payouts</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button class="close-modal" onclick="closeModal()">×</button>
            </div>
            
            <!-- Password Requirements -->
            <div class="password-requirements">
                <div class="requirement-item" id="reqLength">
                    <i class="fas fa-circle requirement-not-met"></i>
                    <span>At least 8 characters</span>
                </div>
                <div class="requirement-item" id="reqUppercase">
                    <i class="fas fa-circle requirement-not-met"></i>
                    <span>At least one uppercase letter</span>
                </div>
                <div class="requirement-item" id="reqLowercase">
                    <i class="fas fa-circle requirement-not-met"></i>
                    <span>At least one lowercase letter</span>
                </div>
                <div class="requirement-item" id="reqNumber">
                    <i class="fas fa-circle requirement-not-met"></i>
                    <span>At least one number</span>
                </div>
                <div class="requirement-item" id="reqSpecial">
                    <i class="fas fa-circle requirement-not-met"></i>
                    <span>At least one special character</span>
                </div>
            </div>
            
            <div class="form-group">
                <label>Current Password</label>
                <div class="password-input-container">
                    <input type="password" id="currentPassword" placeholder="Enter current password">
                    <button type="button" class="password-toggle" onclick="togglePassword('currentPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label>New Password</label>
                <div class="password-input-container">
                    <input type="password" id="newPassword" placeholder="Enter new password (min 8 chars)">
                    <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="password-strength">
                    <div class="password-strength-bar" id="passwordStrengthBar"></div>
                </div>
                <div class="strength-text" id="strengthText">Password strength</div>
            </div>
            
            <div class="form-group">
                <label>Confirm New Password</label>
                <div class="password-input-container">
                    <input type="password" id="confirmPassword" placeholder="Confirm new password">
                    <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div id="passwordMatch" style="font-size: 0.85rem; margin-top: 5px;"></div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-secondary" onclick="updatePassword()" id="updatePasswordBtn">
                    Update Password
                </button>
            </div>
        </div>
    </div>

    <!-- Secret Key Modal -->
    <div class="modal" id="secretKeyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Security Key</h3>
                <button class="close-modal" onclick="closeModal()">×</button>
            </div>
            
            <div class="current-key-display">
                <div class="key-info">
                    <div class="key-label">Current Key</div>
                    <div class="key-value" id="displayCurrentKey">••••••</div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Current Password</label>
                <div class="password-input-container">
                    <input type="password" id="currentPasswordForKey" placeholder="Enter current password">
                    <button type="button" class="password-toggle" onclick="togglePassword('currentPasswordForKey')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label>New Security Key</label>
                <div class="password-input-container">
                    <input type="password" id="newSecretKey" placeholder="Enter new key (6-12 chars)">
                    <button type="button" class="password-toggle" onclick="togglePassword('newSecretKey')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <small style="opacity: 0.7; display: block; margin-top: 5px;">
                    Must be 6-12 characters. This key will be used for login verification.
                </small>
            </div>
            
            <div class="form-group">
                <label>Confirm Security Key</label>
                <div class="password-input-container">
                    <input type="password" id="confirmSecretKey" placeholder="Confirm new key">
                    <button type="button" class="password-toggle" onclick="togglePassword('confirmSecretKey')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div id="secretKeyMatch" style="font-size: 0.85rem; margin-top: 5px;"></div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-secondary" onclick="updateSecretKey()" id="updateSecretKeyBtn">
                    Save Security Key
                </button>
            </div>
        </div>
    </div>

    <!-- Premium Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <span class="nav-icon"><i class="fas fa-home"></i></span>
            <span>Home</span>
        </a>
        <a href="payouts.html" class="nav-item">
            <span class="nav-icon"><i class="fas fa-wallet"></i></span>
            <span>Payouts</span>
        </a>
        <a href="partners.html" class="nav-item">
            <span class="nav-icon"><i class="fas fa-handshake"></i></span>
            <span>Partners</span>
        </a>
        <a href="settings.html" class="nav-item active">
            <span class="nav-icon"><i class="fas fa-cog"></i></span>
            <span>Settings</span>
        </a>
        <a href="support.html" class="nav-item">
            <span class="nav-icon"><i class="fas fa-headset"></i></span>
            <span>Support</span>
        </a>
    </nav>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQDX4eyp7fbmHqbyjytWZEv-jK7XxynqA",
            authDomain: "ggic-investment.firebaseapp.com",
            databaseURL: "https://ggic-investment-default-rtdb.firebaseio.com",
            projectId: "ggic-investment",
            storageBucket: "ggic-investment.firebasestorage.app",
            messagingSenderId: "805530882494",
            appId: "1:805530882494:web:574b965b3ed0402b0f69ef",
            measurementId: "G-NR5R3EJM93"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        console.log("Firebase initialized");

        // DOM Elements
        const userAvatar = document.getElementById('userAvatar');
        const avatarInitial = document.getElementById('avatarInitial');
        const currentKeyDisplay = document.getElementById('currentKeyDisplay');
        const displayCurrentKey = document.getElementById('displayCurrentKey');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profileCreated = document.getElementById('profileCreated');
        const profileStatus = document.getElementById('profileStatus');
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');

        // Current user and secret key
        let currentUser = null;
        let userSecretKey = null;
        let passwordRequirementsMet = false;

        // Initialize page
        function initPage() {
            checkAuth();
            setupPasswordValidation();
            setupSecretKeyValidation();
        }

        // Check authentication
        function checkAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'login.html';
                } else {
                    currentUser = user;
                    loadUserProfile(user);
                    loadUserAvatar(user);
                    await loadUserSecretKey(user.uid);
                    console.log("User logged in:", user.email);
                    
                    // Check URL for success messages
                    checkUrlForSuccessMessages();
                }
            });
        }

        // Check URL for success messages (from redirects)
        function checkUrlForSuccessMessages() {
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');
            
            if (message === 'password_changed') {
                showStickySuccess('Password changed successfully!');
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (message === 'secretkey_changed') {
                showStickySuccess('Security key updated successfully!');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Load user profile information
        async function loadUserProfile(user) {
            try {
                // Default demo user details
                const demoUserEmail = "iamgenefelicity@gmail.com";
                
                // Set profile information
                profileName.textContent = user.displayName || "Acheampong Felicity (Demo)";
                profileEmail.textContent = user.email || demoUserEmail;
                
                // For demo user, always show verified
                if (user.email === demoUserEmail || !user.email) {
                    profileStatus.textContent = "✓ Verified";
                    profileStatus.style.color = "var(--success)";
                } else {
                    // For other users, check email verification
                    if (user.emailVerified) {
                        profileStatus.textContent = "✓ Verified";
                        profileStatus.style.color = "var(--success)";
                    } else {
                        profileStatus.textContent = "⚠ Not Verified";
                        profileStatus.style.color = "var(--warning)";
                    }
                }
                
                // Format account creation date
                if (user.metadata && user.metadata.creationTime) {
                    const createdDate = new Date(user.metadata.creationTime);
                    profileCreated.textContent = createdDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } else {
                    profileCreated.textContent = "N/A";
                }
                
                // Try to get user data from Firestore
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.fullName) {
                            profileName.textContent = userData.fullName;
                        }
                    }
                } catch (dbError) {
                    console.log("No Firestore user data found, using default");
                }
                
            } catch (error) {
                console.error("Error loading user profile:", error);
                // Set default demo values
                profileName.textContent = "Acheampong Felicity (Demo)";
                profileEmail.textContent = "iamgenefelicity@gmail.com";
                profileStatus.textContent = "✓ Verified";
                profileStatus.style.color = "var(--success)";
                profileCreated.textContent = "N/A";
            }
        }

        // Load user avatar
        function loadUserAvatar(user) {
            if (user.photoURL) {
                avatarInitial.style.display = 'none';
                userAvatar.innerHTML = `<img src="${user.photoURL}" alt="Profile">`;
            } else {
                // For demo user, use 'F' for Felicity
                if (user.email === "iamgenefelicity@gmail.com" || !user.email) {
                    avatarInitial.textContent = 'F';
                } else if (user.displayName) {
                    const initials = user.displayName.split(' ').map(n => n[0]).join('').toUpperCase();
                    avatarInitial.textContent = initials || 'U';
                } else if (user.email) {
                    avatarInitial.textContent = user.email[0].toUpperCase();
                }
            }
        }

        // Load user's secret key from Firebase
        async function loadUserSecretKey(userId) {
            try {
                console.log("Loading secret key for user:", userId);
                
                // Try Realtime Database first
                const secretKeyRef = rtdb.ref(`secretKeys/${userId}`);
                const snapshot = await secretKeyRef.get();
                
                if (snapshot.exists()) {
                    userSecretKey = snapshot.val().key;
                    console.log("Secret key found in RTDB:", userSecretKey);
                } else {
                    // Try Firestore as backup
                    const userDoc = await db.collection('users').doc(userId).get();
                    if (userDoc.exists() && userDoc.data().secretKey) {
                        userSecretKey = userDoc.data().secretKey;
                        console.log("Secret key found in Firestore:", userSecretKey);
                    } else {
                        // If no key exists yet, set default
                        userSecretKey = "123456"; // Default demo key
                        console.log("No secret key found, using default");
                    }
                }
                
                // Update UI display
                updateKeyDisplay();
                
            } catch (error) {
                console.error("Error loading secret key:", error);
                userSecretKey = "123456"; // Default on error
                updateKeyDisplay();
            }
        }

        // Update key display in UI
        function updateKeyDisplay() {
            if (userSecretKey && userSecretKey !== "Not set") {
                // Show first 2 and last 2 characters, hide the rest
                const keyLength = userSecretKey.length;
                const maskedKey = userSecretKey.substring(0, 2) + 
                                '•'.repeat(Math.max(0, keyLength - 4)) + 
                                userSecretKey.substring(keyLength - 2);
                currentKeyDisplay.textContent = maskedKey;
                displayCurrentKey.textContent = maskedKey;
            } else {
                currentKeyDisplay.textContent = userSecretKey || "123456";
                displayCurrentKey.textContent = "••••••";
            }
        }

        // Setup password validation
        function setupPasswordValidation() {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', validatePassword);
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', checkPasswordMatch);
            }
        }

        // Setup secret key validation
        function setupSecretKeyValidation() {
            const newSecretKeyInput = document.getElementById('newSecretKey');
            const confirmSecretKeyInput = document.getElementById('confirmSecretKey');
            
            if (newSecretKeyInput && confirmSecretKeyInput) {
                newSecretKeyInput.addEventListener('input', checkSecretKeyMatch);
                confirmSecretKeyInput.addEventListener('input', checkSecretKeyMatch);
            }
        }

        // Validate password strength and requirements
        function validatePassword() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('passwordStrengthBar');
            const strengthText = document.getElementById('strengthText');
            
            // Reset requirements
            let requirements = {
                length: false,
                uppercase: false,
                lowercase: false,
                number: false,
                special: false
            };
            
            let strength = 0;
            
            // Check requirements
            if (password.length >= 8) {
                requirements.length = true;
                strength++;
            }
            
            if (/[A-Z]/.test(password)) {
                requirements.uppercase = true;
                strength++;
            }
            
            if (/[a-z]/.test(password)) {
                requirements.lowercase = true;
                strength++;
            }
            
            if (/[0-9]/.test(password)) {
                requirements.number = true;
                strength++;
            }
            
            if (/[^A-Za-z0-9]/.test(password)) {
                requirements.special = true;
                strength++;
            }
            
            // Update requirement indicators
            updateRequirement('reqLength', requirements.length);
            updateRequirement('reqUppercase', requirements.uppercase);
            updateRequirement('reqLowercase', requirements.lowercase);
            updateRequirement('reqNumber', requirements.number);
            updateRequirement('reqSpecial', requirements.special);
            
            // Update strength bar
            let strengthClass = '';
            let strengthMessage = '';
            
            if (strength <= 1) {
                strengthClass = 'strength-weak';
                strengthMessage = 'Weak password';
            } else if (strength <= 3) {
                strengthClass = 'strength-medium';
                strengthMessage = 'Medium strength';
            } else {
                strengthClass = 'strength-strong';
                strengthMessage = 'Strong password';
            }
            
            strengthBar.className = 'password-strength-bar ' + strengthClass;
            strengthText.textContent = strengthMessage;
            
            // Check if all requirements are met
            passwordRequirementsMet = Object.values(requirements).every(req => req === true);
            
            // Check password match
            checkPasswordMatch();
        }

        // Update requirement indicator
        function updateRequirement(elementId, met) {
            const element = document.getElementById(elementId);
            if (element) {
                const icon = element.querySelector('i');
                const text = element.querySelector('span');
                
                if (met) {
                    icon.className = 'fas fa-check-circle requirement-met';
                    text.style.opacity = '1';
                } else {
                    icon.className = 'fas fa-circle requirement-not-met';
                    text.style.opacity = '0.6';
                }
            }
        }

        // Check if passwords match
        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchElement = document.getElementById('passwordMatch');
            
            if (!newPassword || !confirmPassword) {
                matchElement.textContent = '';
                return;
            }
            
            if (newPassword === confirmPassword) {
                matchElement.textContent = '✓ Passwords match';
                matchElement.style.color = 'var(--success)';
            } else {
                matchElement.textContent = '✗ Passwords do not match';
                matchElement.style.color = 'var(--danger)';
            }
        }

        // Check if secret keys match
        function checkSecretKeyMatch() {
            const newSecretKey = document.getElementById('newSecretKey')?.value || '';
            const confirmSecretKey = document.getElementById('confirmSecretKey')?.value || '';
            const matchElement = document.getElementById('secretKeyMatch');
            
            if (!newSecretKey || !confirmSecretKey) {
                matchElement.textContent = '';
                return;
            }
            
            if (newSecretKey === confirmSecretKey) {
                matchElement.textContent = '✓ Keys match';
                matchElement.style.color = 'var(--success)';
            } else {
                matchElement.textContent = '✗ Keys do not match';
                matchElement.style.color = 'var(--danger)';
            }
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = document.querySelector(`#${inputId} + .password-toggle i`);
            
            if (input.type === 'password') {
                input.type = 'text';
                button.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                button.className = 'fas fa-eye';
            }
        }

        // Show sticky success message
        function showStickySuccess(message) {
            successText.textContent = message;
            successMessage.style.display = 'flex';
            
            // Hide after 5 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        // Modal functions
        function changePassword() {
            document.getElementById('passwordModal').classList.add('active');
            // Trigger initial validation
            validatePassword();
        }

        function manageSecretKey() {
            document.getElementById('secretKeyModal').classList.add('active');
            updateKeyDisplay();
        }

        function updateBankInfo() {
            window.location.href = 'bank-update.html';
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            clearForms();
            resetButtons();
            resetValidation();
        }

        // Clear form inputs
        function clearForms() {
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('currentPasswordForKey').value = '';
            document.getElementById('newSecretKey').value = '';
            document.getElementById('confirmSecretKey').value = '';
        }

        // Reset validation states
        function resetValidation() {
            const strengthBar = document.getElementById('passwordStrengthBar');
            const strengthText = document.getElementById('strengthText');
            const matchElement = document.getElementById('passwordMatch');
            const secretKeyMatchElement = document.getElementById('secretKeyMatch');
            
            if (strengthBar) strengthBar.className = 'password-strength-bar';
            if (strengthText) strengthText.textContent = 'Password strength';
            if (matchElement) matchElement.textContent = '';
            if (secretKeyMatchElement) secretKeyMatchElement.textContent = '';
            
            // Reset requirement indicators
            ['reqLength', 'reqUppercase', 'reqLowercase', 'reqNumber', 'reqSpecial'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const icon = element.querySelector('i');
                    const text = element.querySelector('span');
                    icon.className = 'fas fa-circle requirement-not-met';
                    text.style.opacity = '0.6';
                }
            });
        }

        // Reset buttons to original state
        function resetButtons() {
            const updatePasswordBtn = document.getElementById('updatePasswordBtn');
            const updateSecretKeyBtn = document.getElementById('updateSecretKeyBtn');
            
            if (updatePasswordBtn) {
                updatePasswordBtn.innerHTML = 'Update Password';
                updatePasswordBtn.disabled = false;
            }
            
            if (updateSecretKeyBtn) {
                updateSecretKeyBtn.innerHTML = 'Save Security Key';
                updateSecretKeyBtn.disabled = false;
            }
        }

        // Update password function - FIXED TO SHOW SUCCESS IMMEDIATELY
        async function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const updatePasswordBtn = document.getElementById('updatePasswordBtn');
            
            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                showStickySuccess('Please fill in all fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showStickySuccess('New passwords do not match');
                return;
            }
            
            if (!passwordRequirementsMet) {
                showStickySuccess('Password does not meet all requirements');
                return;
            }
            
            if (newPassword.length < 8) {
                showStickySuccess('Password must be at least 8 characters');
                return;
            }
            
            // Check if new password is same as current
            if (newPassword === currentPassword) {
                showStickySuccess('New password cannot be the same as current password');
                return;
            }
            
            try {
                // Show loading state
                updatePasswordBtn.innerHTML = '<div class="loader"></div> Updating...';
                updatePasswordBtn.disabled = true;
                
                console.log("Starting password update...");
                
                // Re-authenticate user (CRITICAL STEP)
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword
                );
                
                console.log("Re-authenticating...");
                await currentUser.reauthenticateWithCredential(credential);
                
                // Update password in Firebase Authentication
                console.log("Updating password in Firebase Auth...");
                await currentUser.updatePassword(newPassword);
                
                // Save to Firestore for audit trail
                console.log("Saving to Firestore...");
                await db.collection('users').doc(currentUser.uid).set({
                    passwordUpdated: new Date().toISOString(),
                    email: currentUser.email,
                    lastPasswordChange: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Show success message immediately
                showStickySuccess('Password changed successfully!');
                
                // Clear form and close modal
                clearForms();
                resetValidation();
                closeModal();
                
            } catch (error) {
                console.error("Password update error:", error);
                
                // Firebase specific error handling
                let errorMessage = 'Error updating password';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Current password is incorrect';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Try a stronger password.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Session expired. Please login again and try.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many attempts. Please try again later.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your connection.';
                } else {
                    errorMessage = 'Error: ' + error.message;
                }
                
                showStickySuccess(errorMessage);
                
                // Reset button
                updatePasswordBtn.innerHTML = 'Update Password';
                updatePasswordBtn.disabled = false;
            }
        }

        // Update secret key function - FIXED TO SHOW SUCCESS IMMEDIATELY
        async function updateSecretKey() {
            const currentPassword = document.getElementById('currentPasswordForKey').value;
            const newSecretKey = document.getElementById('newSecretKey').value;
            const confirmSecretKey = document.getElementById('confirmSecretKey').value;
            const updateSecretKeyBtn = document.getElementById('updateSecretKeyBtn');
            
            // Validation
            if (!currentPassword || !newSecretKey || !confirmSecretKey) {
                showStickySuccess('Please fill in all fields');
                return;
            }
            
            if (newSecretKey !== confirmSecretKey) {
                showStickySuccess('Security keys do not match');
                return;
            }
            
            if (newSecretKey.length < 6 || newSecretKey.length > 12) {
                showStickySuccess('Security key must be 6-12 characters');
                return;
            }
            
            try {
                // Show loading state
                updateSecretKeyBtn.innerHTML = '<div class="loader"></div> Saving...';
                updateSecretKeyBtn.disabled = true;
                
                console.log("Starting secret key update...");
                
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword
                );
                
                console.log("Re-authenticating...");
                await currentUser.reauthenticateWithCredential(credential);
                
                // Create data object
                const secretKeyData = {
                    key: newSecretKey,
                    updatedAt: new Date().toISOString(),
                    userId: currentUser.uid,
                    email: currentUser.email
                };
                
                // Save to Realtime Database (Primary storage)
                console.log("Saving to Realtime Database...");
                await rtdb.ref(`secretKeys/${currentUser.uid}`).set(secretKeyData);
                
                // Also save to Firestore (Backup storage)
                console.log("Saving to Firestore...");
                await db.collection('users').doc(currentUser.uid).set({
                    secretKey: newSecretKey,
                    secretKeyUpdated: new Date().toISOString(),
                    email: currentUser.email,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Update local state
                userSecretKey = newSecretKey;
                
                // Update UI
                updateKeyDisplay();
                
                // Show success message immediately
                showStickySuccess('Security key updated successfully!');
                
                console.log("Secret key updated successfully!");
                
                // Clear and close modal
                clearForms();
                resetValidation();
                closeModal();
                
            } catch (error) {
                console.error("Secret key update error:", error);
                
                let errorMessage = 'Error updating security key';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Current password is incorrect';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many attempts. Please try again later.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Session expired. Please login again and try.';
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Please check Firebase rules.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your connection.';
                } else {
                    errorMessage = 'Error: ' + error.message;
                }
                
                showStickySuccess(errorMessage);
                
                // Reset button
                updateSecretKeyBtn.innerHTML = 'Save Security Key';
                updateSecretKeyBtn.disabled = false;
            }
        }

        // Logout function
        async function logout() {
            try {
                await auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Logout error:", error);
                window.location.href = 'login.html';
            }
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });

        // Prevent form submission on enter
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                e.preventDefault();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
